<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Принтер 1</title>
<style>
body { margin:0; background:#1e1e1e; font-family:Arial,sans-serif; color:#fff; }
.container { padding:16px; display:flex; flex-direction:column; gap:16px; }
.header { display:flex; align-items:center; gap:16px; }
.back-btn { padding:10px 16px; background:#444; border:none; border-radius:7px; cursor:pointer; font-weight:bold; }
.title { font-size:22px; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.content { display:flex; gap:16px; flex-wrap:wrap; }
.left { flex:1; }
.left img { width:100%; border-radius:7px; object-fit:contain; }
.right { flex:1; background:#2a2a2a; border-radius:7px; padding:12px; display:flex; flex-direction:column; gap:8px; }
.status-row { display:flex; justify-content:space-between; }
.progress { height:24px; background:#444; border-radius:12px; overflow:hidden; margin-top:4px; }
.progress-bar { height:100%; width:0%; background:#4caf50; transition: width 0.3s; }
.controls { display:flex; gap:16px; margin-top:16px; }
button { flex:1; padding:14px; font-weight:bold; border:none; border-radius:7px; cursor:pointer; }
button.disabled { opacity:0.5; pointer-events:none; }
.green { background:#4caf50; color:#fff; }
.red { background:#f44336; color:#fff; }
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.modal-content { background:#2a2a2a; padding:20px; border-radius:7px; display:flex; flex-direction:column; gap:12px; min-width:200px; }
input { padding:8px; border-radius:5px; border:none; }
.modal button { padding:10px; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <button class="back-btn" onclick="goBack()">Назад</button>
    <div class="title" id="printer-title">Принтер 1</div>
  </div>

  <div class="content">
    <div class="left">
      <img src="foto/1.png" alt="Принтер">
    </div>
    <div class="right">
      <div class="status-row"><div>Модель:</div><div id="print-name">—</div></div>
      <div class="status-row"><div>Статус:</div><div id="status-text">Простаивает</div></div>
      <div class="status-row"><div>Готово:</div><div id="progress-text">0%</div></div>
      <div class="status-row"><div>Осталось:</div><div id="time-remaining">0с</div></div>
      <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
      <div class="controls">
        <button id="start" class="green">Поставить в печать</button>
        <button id="stop" class="red">Остановить печать</button>
      </div>
    </div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <label>Модель:</label>
    <input id="modal-model" placeholder="Корпус">
    <label>Время печати (сек):</label>
    <input id="modal-time" type="number" placeholder="120">
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button onclick="startPrint()" class="green">Старт</button>
      <button onclick="closeModal()" class="red">Отмена</button>
    </div>
  </div>
</div>

<script>
const statusText = document.getElementById("status-text");
const printNameText = document.getElementById("print-name");
const progressText = document.getElementById("progress-text");
const timeRemainingText = document.getElementById("time-remaining");
const progressBar = document.getElementById("progress-bar");
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const modal = document.getElementById("modal");

function getPrinterData() {
  return {
    status: localStorage.getItem("printerStatus") || "idle",
    printName: localStorage.getItem("printerPrintName") || "",
    totalSeconds: parseInt(localStorage.getItem("printerTotalSeconds")) || 0,
    startTime: parseInt(localStorage.getItem("printerStartTime")) || 0,
    savedPercent: parseInt(localStorage.getItem("printerSavedPercent")) || 0
  };
}

function savePrinterData(printer){
  localStorage.setItem("printerStatus", printer.status);
  localStorage.setItem("printerPrintName", printer.printName);
  localStorage.setItem("printerTotalSeconds", printer.totalSeconds);
  localStorage.setItem("printerStartTime", printer.startTime);
  localStorage.setItem("printerSavedPercent", printer.savedPercent);
}

// ===== ОБНОВЛЕНИЕ UI =====
function updateUI(){
  let printer = getPrinterData();
  const now = Date.now();
  let elapsed = 0;

  if(printer.status==="printing"){
    elapsed = Math.floor((now - printer.startTime)/1000);
    if(elapsed >= printer.totalSeconds){
      printer.status="idle";
      elapsed = printer.totalSeconds;
      printer.savedPercent = 100;
      savePrinterData(printer);
    }
  } else if(printer.status==="stopped"){
    // сохраняем процент на котором остановились
    elapsed = Math.floor(printer.totalSeconds * printer.savedPercent / 100);
  } else { // idle
    elapsed = 0;
    printer.savedPercent = 0;
  }

  let percent = printer.totalSeconds ? Math.floor((elapsed/printer.totalSeconds)*100) : 0;
  if(printer.status==="stopped") percent = printer.savedPercent;
  else printer.savedPercent = percent;

  statusText.textContent = printer.status==="idle"?"Простаивает":printer.status==="printing"?"Печать":"Печать остановлена";
  printNameText.textContent = printer.printName || "—";
  progressText.textContent = percent+"%";
  let remaining = printer.totalSeconds - elapsed;
  timeRemainingText.textContent = printer.status==="printing"?remaining+"с":"0с";

  if(printer.status==="stopped"){
    statusText.style.color="orange";
    progressBar.style.background="orange";
  } else {
    statusText.style.color="#fff";
    progressBar.style.background="#4caf50";
  }

  progressBar.style.width = percent+"%";

  startBtn.classList.toggle("disabled", printer.status==="printing");
  stopBtn.classList.toggle("disabled", printer.status!=="printing");

  savePrinterData(printer);
}
updateUI();
setInterval(updateUI,1000);

// ===== КНОПКИ =====
startBtn.onclick = ()=>{
  let printer = getPrinterData();
  if(printer.status!=="printing") modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

function startPrint(){
  let printer = getPrinterData();
  let name = document.getElementById("modal-model").value || "Корпус";
  let time = parseInt(document.getElementById("modal-time").value) || 60;

  printer.printName=name;
  printer.totalSeconds=time;
  printer.startTime=Date.now();
  printer.status="printing";
  printer.savedPercent = 0;
  savePrinterData(printer);
  updateUI();
  modal.style.display="none";
}

stopBtn.onclick=()=>{
  let printer = getPrinterData();
  if(printer.status==="printing"){
    if(confirm("Точно остановить печать?")){
      printer.status="stopped";
      const now = Date.now();
      const elapsed = Math.floor((now - printer.startTime)/1000);
      printer.savedPercent = Math.floor((elapsed/printer.totalSeconds)*100);
      savePrinterData(printer);
      updateUI();
    }
  }
}

function goBack(){ document.body.style.animation="pageExit 0.2s forwards ease-in"; setTimeout(()=>history.back(),200);}
</script>

</body>
</html>
