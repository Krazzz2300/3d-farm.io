<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Принтер</title>
<style>
body{margin:0;background:#1e1e1e;color:#fff;font-family:Arial,sans-serif;opacity:0;transform:translateX(40px);animation:pageEnter 0.25s forwards ease-out;}
@keyframes pageEnter{from{opacity:0;transform:translateX(40px);}to{opacity:1;transform:translateX(0);} }
@keyframes pageExit{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(40px);} }

.header{display:flex;align-items:center;gap:16px;padding:16px;}
.back-btn{background:#2e2e2e;color:#fff;border:none;border-radius:12px;padding:20px;font-size:18px;font-weight:bold;cursor:pointer;}
.back-btn:active{transform:scale(0.95);}
.title{font-size:32px;font-weight:bold;display:flex;align-items:center;gap:8px;}

.top-block{display:flex;gap:16px;padding:0 16px;}
.photo-block{width:50%;}
.photo-block img{width:100%;height:auto;border-radius:7px;object-fit:contain;}
.info-block{width:50%;background:#2a2a2a;border-radius:7px;padding:16px;}
.model-label{font-size:18px;opacity:0.7;}
.model-value{font-size:20px;font-weight:bold;white-space:nowrap;}
.problem-value{font-size:18px;opacity:0.8;margin-top:4px;}

.status-block{margin:24px 16px;background:#2a2a2a;border-radius:7px;padding:20px;}
.status-row{display:grid;grid-template-columns:140px 1fr;align-items:center;margin-bottom:12px;}
.status-label{background:#242424;border-radius:6px;padding:6px 10px;font-size:18px;opacity:0.85;}
.status-value{font-size:22px;padding-left:12px;}
.progress{margin-top:16px;height:18px;background:#444;border-radius:9px;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:#4caf50;transition:width 0.3s;}
@keyframes pulse{0%{background-color:#4caf50;}50%{background-color:#00ff00;}100%{background-color:#4caf50;}}

.color-block{margin:0 16px 24px;background:#2a2a2a;border-radius:7px;padding:20px;display:flex;align-items:center;gap:16px;font-size:22px;}
.color-circle{width:32px;height:32px;border-radius:50%;background:red;}

.control-block{display:flex;justify-content:center;gap:16px;margin:0 16px 24px;}
button.control-btn{flex:1;margin:0;padding:20px;font-size:20px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;}
button#start{background:#4caf50;color:#fff;}
button#stop{background:#f44336;color:#fff;}
button#repair{background:orange;color:#fff;}
button.disabled{opacity:0.5;cursor:default;}

.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10;}
.modal{background:#2a2a2a;padding:24px;border-radius:10px;width:90%;max-width:400px;}
.modal label{display:block;margin:12px 0 4px;}
.modal input{width:100%;padding:8px;font-size:18px;border-radius:6px;border:none;}
.color-options{display:grid;grid-template-columns:3fr 3fr 3fr;gap:12px;margin-top:12px;}
.color-option{width:36px;height:36px;border-radius:50%;cursor:pointer;border:2px solid #2a2a2a;}
.color-option.selected{border:3px solid #fff;}
.modal-buttons{display:flex;justify-content:space-between;margin-top:16px;}
.modal-buttons button{flex:1;margin:0 4px;padding:12px;font-size:18px;border-radius:7px;border:none;font-weight:bold;}
.modal-buttons button.cancel{background:#f44336;color:#fff;}
.modal-buttons button.ok{background:#4caf50;color:#fff;}

#finished-popup {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:20;}
#finished-popup .modal {text-align:center;}
</style>
</head>
<body>

<div class="header">
  <button class="back-btn" onclick="goBack()">←</button>
  <div class="title">Принтер 1</div>
</div>

<div class="top-block">
  <div class="photo-block">
    <img src="foto/1.png" alt="Bambu Lab A1">
  </div>
  <div class="info-block">
    <div class="model-label">Модель</div>
    <div class="model-value" id="model-value">Bambu Lab A1</div>
    <div class="problem-value" id="problem-value">Проблема: нет</div>
  </div>
</div>

<div class="status-block">
  <div class="status-row">
    <div class="status-label">Статус</div>
    <div class="status-value" id="status-text">Простаивает</div>
  </div>
  <div class="status-row">
    <div class="status-label">Печать</div>
    <div class="status-value" id="print-name">—</div>
  </div>
  <div class="status-row">
    <div class="status-label">Готово</div>
    <div class="status-value" id="progress-text">0%</div>
  </div>
  <div class="progress">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
</div>

<div class="color-block">
  <div>Цвет печати</div>
  <div class="color-circle" id="color-circle"></div>
</div>

<div class="control-block">
  <button id="start" class="control-btn">Поставить в печать</button>
  <button id="stop" class="control-btn disabled">Остановить печать</button>
  <button id="repair" class="control-btn">Отправить на ремонт</button>
</div>

<!-- Модалка для установки печати -->
<div class="modal-bg" id="modal">
  <div class="modal">
    <label>Модель/Название печати:</label>
    <input type="text" id="modal-model" placeholder="Корпус">
    <label>Время печати (секунды):</label>
    <input type="number" id="modal-time" placeholder="60">
    <label>Выберите цвет печати:</label>
    <div class="color-options" id="color-options">
      <div class="color-option" data-color="red" style="background:red;"></div>
      <div class="color-option" data-color="white" style="background:white;"></div>
      <div class="color-option" data-color="blue" style="background:blue;"></div>
      <div class="color-option" data-color="yellow" style="background:yellow;"></div>
      <div class="color-option" data-color="green" style="background:green;"></div>
      <div class="color-option" data-color="orange" style="background:orange;"></div>
      <div class="color-option" data-color="purple" style="background:purple;"></div>
      <div class="color-option" data-color="black" style="background:black;"></div>
      <div class="color-option" data-color="pink" style="background:pink;"></div>
    </div>
    <div class="modal-buttons">
      <button class="cancel" onclick="closeModal()">Отмена</button>
      <button class="ok" onclick="startPrint()">Готово</button>
    </div>
  </div>
</div>

<!-- Попап завершения печати -->
<div id="finished-popup" class="modal-bg">
  <div class="modal">
    <h2>Печать завершена</h2>
    <button class="control-btn" style="background:#4caf50;color:#fff;padding:20px;font-size:20px;border-radius:12px;" onclick="ackFinish()">Окей</button>
  </div>
</div>

<script>
const statusText = document.getElementById("status-text");
const printNameText = document.getElementById("print-name");
const progressText = document.getElementById("progress-text");
const progressBar = document.getElementById("progress-bar");
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const repairBtn = document.getElementById("repair");
const modal = document.getElementById("modal");
const colorCircle = document.getElementById("color-circle");
const colorOptions = document.getElementById("color-options").children;
const finishedPopup = document.getElementById("finished-popup");
const modelValue = document.getElementById("model-value");
const problemValue = document.getElementById("problem-value");

let selectedColor = "red";

function getPrinterData(){
  return {
    status: localStorage.getItem("printerStatus") || "idle",
    printName: localStorage.getItem("printerPrintName") || "",
    totalSeconds: parseInt(localStorage.getItem("printerTotalSeconds")) || 0,
    startTime: parseInt(localStorage.getItem("printerStartTime")) || 0,
    savedPercent: parseInt(localStorage.getItem("printerSavedPercent")) || 0,
    color: localStorage.getItem("printerColor") || "red",
    finishedNotified: localStorage.getItem("printerFinishedNotified") === "true",
    problem: localStorage.getItem("printerProblem") || "нет"
  };
}

function savePrinterData(printer){
  localStorage.setItem("printerStatus", printer.status);
  localStorage.setItem("printerPrintName", printer.printName);
  localStorage.setItem("printerTotalSeconds", printer.totalSeconds);
  localStorage.setItem("printerStartTime", printer.startTime);
  localStorage.setItem("printerSavedPercent", printer.savedPercent);
  localStorage.setItem("printerColor", printer.color);
  localStorage.setItem("printerFinishedNotified", printer.finishedNotified);
  localStorage.setItem("printerProblem", printer.problem);
}

function updateUI(){
  let printer = getPrinterData();
  const now = Date.now();
  let elapsed = 0;

  if(printer.status==="printing"){
    elapsed = Math.floor((now - printer.startTime)/1000);
    if(elapsed >= printer.totalSeconds){
      printer.status="finished";
      printer.savedPercent=100;
      printer.finishedNotified=false;
      savePrinterData(printer);
    }
  } else if(printer.status==="stopped"){
    elapsed = Math.floor(printer.totalSeconds * printer.savedPercent / 100);
  }

  let percent = printer.totalSeconds ? Math.floor((elapsed/printer.totalSeconds)*100) : 0;
  if(printer.status==="stopped" || printer.status==="repair") percent = printer.savedPercent;
  else printer.savedPercent = percent;

  statusText.textContent =
    printer.status==="idle" ? "Простаивает" :
    printer.status==="printing" ? "Печать" :
    printer.status==="stopped" ? "Печать остановлена" :
    printer.status==="finished" ? "Готово" :
    printer.status==="repair" ? "На ремонте" : "";

  printNameText.textContent = printer.status==="idle" ? "—" : printer.printName || "—";
  progressText.textContent = percent+"%";
  problemValue.textContent = "Проблема: "+printer.problem;

  if(printer.status==="stopped"){
    statusText.style.color="orange";
    progressBar.style.background="orange";
    progressBar.style.animation="none";
  } else if(printer.status==="finished"){
    statusText.style.color="#4caf50";
    progressBar.style.animation="pulse 1s infinite";
    progressBar.style.background="#4caf50";
    if(!printer.finishedNotified){
      finishedPopup.style.display="flex";
      printer.finishedNotified=true;
      savePrinterData(printer);
    }
  } else if(printer.status==="repair"){
    statusText.style.color="red";
    progressBar.style.background="red";
    progressBar.style.width="100%";
    progressBar.style.animation="none";
  } else {
    statusText.style.color="#fff";
    progressBar.style.background="#4caf50";
    progressBar.style.animation="none";
  }

  progressBar.style.width = percent+"%";
  colorCircle.style.background = printer.color;

  startBtn.classList.toggle("disabled", printer.status==="printing" || printer.status==="repair");
  stopBtn.classList.toggle("disabled", printer.status!=="printing" || printer.status==="repair");

  repairBtn.textContent = printer.status==="repair" ? "Снять с ремонта" : "Отправить на ремонт";

  savePrinterData(printer);
}

setInterval(updateUI,1000);
updateUI();

// ===== Кнопки =====
startBtn.onclick=()=>{if(getPrinterData().status!=="printing" && getPrinterData().status!=="repair") modal.style.display="flex";}
function closeModal(){modal.style.display="none";}

for(let c of colorOptions){
  c.onclick=()=>{
    selectedColor=c.dataset.color;
    for(let cc of colorOptions) cc.classList.remove("selected");
    c.classList.add("selected");
  }
}

function startPrint(){
  let printer = getPrinterData();
  let name=document.getElementById("modal-model").value||"Корпус";
  let time=parseInt(document.getElementById("modal-time").value)||60;

  printer.printName=name;
  printer.totalSeconds=time;
  printer.startTime=Date.now();
  printer.status="printing";
  printer.savedPercent=0;
  printer.color=selectedColor;
  printer.finishedNotified=false;

  savePrinterData(printer);
  updateUI();
  modal.style.display="none";
}

stopBtn.onclick=()=>{
  let printer=getPrinterData();
  if(printer.status==="printing"){
    if(confirm("Точно остановить печать?")){
      const now = Date.now();
      const elapsed = Math.floor((now - printer.startTime)/1000);
      printer.savedPercent = Math.floor((elapsed/printer.totalSeconds)*100);
      printer.status="stopped";
      savePrinterData(printer);
      updateUI();
    }
  }
}

repairBtn.onclick=()=>{
  let printer=getPrinterData();
  if(printer.status!=="repair"){
    // отправка в ремонт
    let reason = prompt("Укажите причину поломки:");
    if(!reason) return;
    if(confirm("Точно отправить принтер в ремонт?")){
      printer.status="repair";
      printer.problem = reason;
      printer.savedPercent = 100;
      printer.printName="";
      savePrinterData(printer);
      updateUI();
    }
  } else {
    // снятие с ремонта
    if(confirm("Снять принтер с ремонта?")){
      printer.status="idle";
      printer.problem="нет";
      printer.savedPercent=0;
      printer.printName="";
      savePrinterData(printer);
      updateUI();
    }
  }
}

function ackFinish(){
  let printer = getPrinterData();
  printer.status="idle";
  printer.savedPercent=0;
  printer.printName="";
  printer.finishedNotified=false;
  savePrinterData(printer);
  finishedPopup.style.display="none";
  updateUI();
}

function goBack(){document.body.style.animation="pageExit 0.2s forwards ease-in"; setTimeout(()=>history.back(),200);}
</script>

</body>
</html>
