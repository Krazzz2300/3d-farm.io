<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Принтер</title>
<style>
body{margin:0;background:#1e1e1e;color:#fff;font-family:Arial,sans-serif;opacity:0;transform:translateX(40px);animation:pageEnter 0.25s forwards ease-out;}
@keyframes pageEnter{from{opacity:0;transform:translateX(40px);}to{opacity:1;transform:translateX(0);} }
@keyframes pageExit{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(40px);} }

.header{display:flex;align-items:center;gap:16px;padding:16px;}
.back-btn{background:#2e2e2e;color:#fff;border:none;border-radius:12px;padding:20px;font-size:18px;font-weight:bold;cursor:pointer;}
.back-btn:active{transform:scale(0.95);}
.title{font-size:32px;font-weight:bold;}

.top-block{display:flex;gap:16px;padding:0 16px;}
.photo-block{width:50%;}
.photo-block img{width:100%;height:auto;border-radius:7px;object-fit:contain;}
.info-block{width:50%;background:#2a2a2a;border-radius:7px;padding:16px;}
.model-label{font-size:18px;opacity:0.7;}
.model-value{font-size:20px;font-weight:bold;white-space:nowrap;}

.status-block{margin:24px 16px;background:#2a2a2a;border-radius:7px;padding:20px;}
.status-row{display:grid;grid-template-columns:140px 1fr;align-items:center;margin-bottom:12px;}
.status-label{background:#242424;border-radius:6px;padding:6px 10px;font-size:18px;opacity:0.85;}
.status-value{font-size:22px;padding-left:12px;}
.progress{margin-top:16px;height:18px;background:#444;border-radius:9px;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:#4caf50;transition:width 0.3s;}
.progress-bar.completed{animation:greenPulse 1s infinite;}

@keyframes greenPulse{
  0%{background-color:#4caf50;}
  50%{background-color:#7CFC00;}
  100%{background-color:#4caf50;}
}

.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;}
.modal{background:#2a2a2a;padding:24px;border-radius:10px;width:90%;max-width:400px;text-align:center;}
.modal button{padding:20px; font-size:20px; font-weight:bold; border:none; border-radius:12px; cursor:pointer; background:#4caf50; color:#fff;}
</style>
</head>
<body>

<div class="header">
  <button class="back-btn" onclick="goBack()">←</button>
  <div class="title" id="printer-title">Принтер</div>
</div>

<div class="top-block">
  <div class="photo-block">
    <img id="printer-img" src="foto/1.png" alt="Принтер">
  </div>
  <div class="info-block">
    <div class="model-label">Модель</div>
    <div class="model-value" id="model-value"></div>
  </div>
</div>

<div class="status-block">
  <div class="status-row">
    <div class="status-label">Статус</div>
    <div class="status-value" id="status-text">Простаивает</div>
  </div>
  <div class="status-row">
    <div class="status-label">Печать</div>
    <div class="status-value" id="print-name">—</div>
  </div>
  <div class="status-row">
    <div class="status-label">Готово</div>
    <div class="status-value" id="progress-text">0%</div>
  </div>
  <div class="progress">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
</div>

<div class="modal-bg" id="modal">
  <div class="modal">
    <p>Печать завершена!</p>
    <button onclick="confirmCompleted()">ОКЕЙ</button>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const printerId = params.get("id") || 1;

function getPrinterData(){
  return {
    status: localStorage.getItem(`printerStatus_${printerId}`) || "idle",
    printName: localStorage.getItem(`printerPrintName_${printerId}`) || "",
    totalSeconds: parseInt(localStorage.getItem(`printerTotalSeconds_${printerId}`)) || 0,
    startTime: parseInt(localStorage.getItem(`printerStartTime_${printerId}`)) || 0,
    savedPercent: parseInt(localStorage.getItem(`printerSavedPercent_${printerId}`)) || 0,
    color: localStorage.getItem(`printerColor_${printerId}`) || "red",
    completedNotified: localStorage.getItem(`printerCompletedNotified_${printerId}`) === "true"
  };
}

function savePrinterData(data){
  localStorage.setItem(`printerStatus_${printerId}`, data.status);
  localStorage.setItem(`printerPrintName_${printerId}`, data.printName);
  localStorage.setItem(`printerTotalSeconds_${printerId}`, data.totalSeconds);
  localStorage.setItem(`printerStartTime_${printerId}`, data.startTime);
  localStorage.setItem(`printerSavedPercent_${printerId}`, data.savedPercent);
  localStorage.setItem(`printerColor_${printerId}`, data.color);
  localStorage.setItem(`printerCompletedNotified_${printerId}`, data.completedNotified);
}

function updateUI(){
  let printer = getPrinterData();
  const now = Date.now();
  let elapsed = 0;

  if(printer.status==="printing"){
    elapsed = Math.floor((now - printer.startTime)/1000);
    if(elapsed >= printer.totalSeconds){
      printer.status="completed";
      printer.savedPercent = 100;
      printer.completedNotified = false;
    }
  } else if(printer.status==="stopped"){
    elapsed = Math.floor(printer.totalSeconds * printer.savedPercent / 100);
  } else if(printer.status==="completed"){
    elapsed = printer.totalSeconds;
  }

  let percent = printer.totalSeconds ? Math.floor((elapsed/printer.totalSeconds)*100) : 0;
  if(printer.status==="stopped") percent = printer.savedPercent;
  else printer.savedPercent = percent;

  document.getElementById("status-text").textContent =
    printer.status==="idle"?"Простаивает":
    printer.status==="printing"?"Печать":
    printer.status==="stopped"?"Печать остановлена":
    "Готово";

  document.getElementById("print-name").textContent = printer.printName || "—";
  document.getElementById("progress-text").textContent = percent+"%";

  const bar = document.getElementById("progress-bar");
  if(printer.status==="completed"){
    bar.classList.add("completed");
    if(!printer.completedNotified){
      document.getElementById("modal").style.display="flex";
    }
  } else if(printer.status==="stopped"){
    bar.classList.remove("completed");
    bar.style.background="orange";
  } else {
    bar.classList.remove("completed");
    bar.style.background="#4caf50";
  }
  bar.style.width = percent+"%";

  savePrinterData(printer);
}

function confirmCompleted(){
  let printer = getPrinterData();
  printer.status="idle";
  printer.printName="";
  printer.totalSeconds=0;
  printer.startTime=0;
  printer.savedPercent=0;
  printer.completedNotified=true;
  savePrinterData(printer);
  document.getElementById("modal").style.display="none";
  updateUI();
}

function goBack(){document.body.style.animation="pageExit 0.2s forwards ease-in"; setTimeout(()=>history.back(),200);}

setInterval(updateUI,1000);
updateUI();
</script>

</body>
</html>
