<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Принтер</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="header">
  <button class="back-btn" onclick="goBack()">←</button>
  <div class="title">Принтер 1</div>
</div>
<div class="top-block">
  <div class="photo-block">
    <img src="foto/1.png" alt="Bambu Lab A1">
  </div>
  <div class="info-block">
    <div class="model-label">Модель</div>
    <div class="model-value" id="model-value">Bambu Lab A1</div>
  </div>
</div>
<div class="status-block">
  <div class="status-row">
    <div class="status-label">Статус</div>
    <div class="status-value" id="status-text">Простаивает</div>
  </div>
  <div class="status-row">
    <div class="status-label">Печать</div>
    <div class="status-value" id="print-name">—</div>
  </div>
  <div class="status-row">
    <div class="status-label">Готово</div>
    <div class="status-value" id="progress-text">0%</div>
  </div>
  <div class="progress">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
</div>
<div class="color-block">
  <div>Цвет печати</div>
  <div class="color-circle" id="color-circle"></div>
</div>
<div class="control-block">
  <button id="start" class="control-btn">Поставить в печать</button>
  <button id="stop" class="control-btn disabled">Остановить печать</button>
</div>
<div class="modal-bg" id="modal">
  <div class="modal">
    <label>Модель/Название печати:</label>
    <input type="text" id="modal-model" placeholder="Корпус">
    <label>Время печати (секунды):</label>
    <input type="number" id="modal-time" placeholder="60">
    <label>Выберите цвет печати:</label>
    <div class="color-options" id="color-options">
      <div class="color-option" data-color="red" style="background:red;"></div>
      <div class="color-option" data-color="white" style="background:white;"></div>
      <div class="color-option" data-color="blue" style="background:blue;"></div>
    </div>
    <div class="modal-buttons">
      <button class="cancel" onclick="closeModal()">Отмена</button>
      <button class="ok" onclick="startPrint()">Готово</button>
    </div>
  </div>
</div>
<div id="finished-popup" class="modal-bg">
  <div class="modal">
    <h2>Печать завершена</h2>
    <button onclick="ackFinish()">Окей</button>
  </div>
</div>
<script>
const statusText=document.getElementById("status-text");
const printNameText=document.getElementById("print-name");
const progressText=document.getElementById("progress-text");
const progressBar=document.getElementById("progress-bar");
const startBtn=document.getElementById("start");
const stopBtn=document.getElementById("stop");
const modal=document.getElementById("modal");
const colorCircle=document.getElementById("color-circle");
const colorOptions=document.getElementById("color-options").children;
const finishedPopup=document.getElementById("finished-popup");
let selectedColor="red";
function getPrinterData(){
  return {status:localStorage.getItem("printerStatus")||"idle",
  printName:localStorage.getItem("printerPrintName")||"",
  totalSeconds:parseInt(localStorage.getItem("printerTotalSeconds"))||0,
  startTime:parseInt(localStorage.getItem("printerStartTime"))||0,
  savedPercent:parseInt(localStorage.getItem("printerSavedPercent"))||0,
  color:localStorage.getItem("printerColor")||"red",
  finishedNotified:localStorage.getItem("printerFinishedNotified")==="true"};
}
function savePrinterData(printer){
  localStorage.setItem("printerStatus",printer.status);
  localStorage.setItem("printerPrintName",printer.printName);
  localStorage.setItem("printerTotalSeconds",printer.totalSeconds);
  localStorage.setItem("printerStartTime",printer.startTime);
  localStorage.setItem("printerSavedPercent",printer.savedPercent);
  localStorage.setItem("printerColor",printer.color);
  localStorage.setItem("printerFinishedNotified",printer.finishedNotified);
}
function updateUI(){
  let printer=getPrinterData();
  const now=Date.now();
  let elapsed=0;
  if(printer.status==="printing"){
    elapsed=Math.floor((now-printer.startTime)/1000);
    if(elapsed>=printer.totalSeconds){
      printer.status="finished";
      printer.savedPercent=100;
      printer.finishedNotified=false;
    }
  }else if(printer.status==="stopped"){elapsed=Math.floor(printer.totalSeconds*printer.savedPercent/100);}
  let percent=printer.totalSeconds?Math.floor(elapsed/printer.totalSeconds*100):0;
  if(printer.status==="stopped") percent=printer.savedPercent; else printer.savedPercent=percent;
  statusText.textContent=printer.status==="idle"?"Простаивает":printer.status==="printing"?"Печать":"Готово";
  printNameText.textContent=printer.status==="idle"?"—":printer.printName||"—";
  progressText.textContent=percent+"%";
  if(printer.status==="stopped"){
    statusText.style.color="orange";
    progressBar.style.background="orange";
    progressBar.style.animation="none";
  }else if(printer.status==="finished"){
    statusText.style.color="#4caf50";
    progressBar.style.animation="pulse 1s infinite";
    progressBar.style.background="#4caf50";
    if(!printer.finishedNotified){finishedPopup.style.display="flex"; printer.finishedNotified=true;}
  }else{statusText.style.color="#fff"; progressBar.style.background="#4caf50"; progressBar.style.animation="none";}
  progressBar.style.width=percent+"%";
  colorCircle.style.background=printer.color;
  startBtn.classList.toggle("disabled",printer.status==="printing");
  stopBtn.classList.toggle("disabled",printer.status!=="printing");
  savePrinterData(printer);
}
setInterval(updateUI,1000);
updateUI();
startBtn.onclick=()=>{if(getPrinterData().status!=="printing") modal.style.display="flex";}
function closeModal(){modal.style.display="none";}
for(let c of colorOptions){c.onclick=()=>{selectedColor=c.dataset.color;for(let cc of colorOptions) cc.classList.remove("selected");c.classList.add("selected");}}
function startPrint(){let printer=getPrinterData(); let name=document.getElementById("modal-model").value||"Корпус"; let time=parseInt(document.getElementById("modal-time").value)||60;
printer.printName=name; printer.totalSeconds=time; printer.startTime=Date.now(); printer.status="printing"; printer.savedPercent=0; printer.color=selectedColor; printer.finishedNotified=false; savePrinterData(printer); updateUI(); modal.style.display="none";}
stopBtn.onclick=()=>{let printer=getPrinterData(); if(printer.status==="printing"){if(confirm("Точно остановить печать?")){const now=Date.now(); const elapsed=Math.floor((now-printer.startTime)/1000); printer.savedPercent=Math.floor((elapsed/printer.totalSeconds)*100); printer.status="stopped"; savePrinterData(printer); updateUI();}}}
function ackFinish(){let printer=getPrinterData(); printer.status="idle"; printer.savedPercent=0; printer.printName=""; printer.finishedNotified=false; savePrinterData(printer); finishedPopup.style.display="none"; updateUI();}
function goBack(){document.body.style.animation="pageExit 0.2s forwards ease-in"; setTimeout(()=>history.back(),200);}
</script>
</body>
</html>
