<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Управление принтером</title>
<style>
/* Простой CSS для страницы принтера */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: #1e1e1e;
  color: #fff;
  font-family: Arial, sans-serif;
}

.header {
  background: #2a2a2a;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.back-btn {
  background: #333;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 15px;
  font-size: 18px;
  cursor: pointer;
}

.title {
  font-size: 20px;
  font-weight: bold;
}

.content {
  padding: 15px;
}

.info-box {
  background: #2a2a2a;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 16px;
}

.control-btn {
  width: 100%;
  padding: 15px;
  margin: 10px 0;
  border-radius: 10px;
  border: none;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}

.start-btn { background: #4caf50; color: white; }
.stop-btn { background: #f44336; color: white; }
.repair-btn { background: orange; color: white; }
</style>
</head>
<body>

<div class="header">
  <button class="back-btn" onclick="goBack()">← Назад</button>
  <div class="title" id="printer-title">Загрузка...</div>
</div>

<div class="content">
  <div class="info-box">
    <div class="info-row">
      <span>Статус:</span>
      <span id="status-text">Загрузка...</span>
    </div>
    <div class="info-row">
      <span>Модель:</span>
      <span id="model-text">Загрузка...</span>
    </div>
    <div class="info-row">
      <span>Печатает:</span>
      <span id="print-text">—</span>
    </div>
    <div class="info-row">
      <span>Готово:</span>
      <span id="progress-text">0%</span>
    </div>
  </div>
  
  <button class="control-btn start-btn" onclick="startPrint()">Начать печать</button>
  <button class="control-btn stop-btn" onclick="stopPrint()">Остановить</button>
  <button class="control-btn repair-btn" onclick="toggleRepair()">В ремонт / С ремонта</button>
</div>

<script>
// Получаем ID принтера из URL
const urlParams = new URLSearchParams(window.location.search);
const printerId = urlParams.get('id') || 'printer1';

// Ключ для хранения данных (такой же как в index.html)
const STORAGE_KEY = '3d_printer_farm_data';

// Получить данные принтеров
function getPrinters() {
  try {
    const savedData = localStorage.getItem(STORAGE_KEY);
    return savedData ? JSON.parse(savedData) : [];
  } catch (error) {
    console.error("Ошибка при чтении данных:", error);
    return [];
  }
}

// Сохранить данные принтеров
function savePrinters(printers) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(printers));
    return true;
  } catch (error) {
    console.error("Ошибка при сохранении:", error);
    return false;
  }
}

// Получить текущий принтер
function getCurrentPrinter() {
  const printers = getPrinters();
  return printers.find(p => p.id === printerId) || null;
}

// Обновить принтер
function updatePrinter(updatedPrinter) {
  const printers = getPrinters();
  const index = printers.findIndex(p => p.id === printerId);
  
  if (index !== -1) {
    printers[index] = updatedPrinter;
    savePrinters(printers);
    return true;
  }
  
  return false;
}

// Загрузить данные принтера на страницу
function loadPrinterData() {
  const printer = getCurrentPrinter();
  
  if (!printer) {
    document.getElementById('printer-title').textContent = 'Принтер не найден';
    return;
  }
  
  // Обновляем интерфейс
  document.getElementById('printer-title').textContent = printer.name;
  document.getElementById('model-text').textContent = printer.model;
  document.getElementById('status-text').textContent = getStatusText(printer.status);
  document.getElementById('print-text').textContent = printer.printName || '—';
  document.getElementById('progress-text').textContent = printer.progress + '%';
  
  // Цвет статуса
  const statusColor = getStatusColor(printer.status);
  document.getElementById('status-text').style.color = statusColor;
}

function getStatusText(status) {
  const statusMap = {
    'idle': 'Простаивает',
    'printing': 'Печать',
    'stopped': 'Остановлено',
    'finished': 'Готово',
    'repair': 'На ремонте'
  };
  return statusMap[status] || status;
}

function getStatusColor(status) {
  const colorMap = {
    'idle': '#fff',
    'printing': '#fff',
    'stopped': 'orange',
    'finished': '#4caf50',
    'repair': 'red'
  };
  return colorMap[status] || '#fff';
}

// Управление принтером
function startPrint() {
  const printer = getCurrentPrinter();
  
  if (printer && printer.status !== 'repair') {
    const printName = prompt('Что печатаем?', 'Деталь');
    const printTime = prompt('Время печати (сек):', '60');
    
    if (printName && printTime) {
      printer.status = 'printing';
      printer.printName = printName;
      printer.progress = 0;
      
      // Сохраняем время начала печати
      printer.startTime = Date.now();
      printer.printDuration = parseInt(printTime) * 1000; // в миллисекундах
      
      updatePrinter(printer);
      loadPrinterData();
      alert('Печать начата!');
    }
  } else if (printer.status === 'repair') {
    alert('Принтер в ремонте!');
  }
}

function stopPrint() {
  const printer = getCurrentPrinter();
  
  if (printer && printer.status === 'printing') {
    if (confirm('Остановить печать?')) {
      printer.status = 'stopped';
      updatePrinter(printer);
      loadPrinterData();
    }
  }
}

function toggleRepair() {
  const printer = getCurrentPrinter();
  
  if (printer) {
    if (printer.status !== 'repair') {
      const reason = prompt('Причина ремонта:');
      if (reason) {
        printer.status = 'repair';
        printer.progress = 100;
        updatePrinter(printer);
        loadPrinterData();
      }
    } else {
      printer.status = 'idle';
      printer.progress = 0;
      printer.printName = '';
      updatePrinter(printer);
      loadPrinterData();
    }
  }
}

function goBack() {
  window.history.back();
}

// Обновление прогресса печати
function updatePrintProgress() {
  const printer = getCurrentPrinter();
  
  if (printer && printer.status === 'printing' && printer.startTime && printer.printDuration) {
    const elapsed = Date.now() - printer.startTime;
    const progress = Math.min(100, Math.floor((elapsed / printer.printDuration) * 100));
    
    if (progress !== printer.progress) {
      printer.progress = progress;
      
      if (progress >= 100) {
        printer.status = 'finished';
      }
      
      updatePrinter(printer);
      loadPrinterData();
    }
  }
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
  loadPrinterData();
  
  // Обновляем прогресс каждую секунду
  setInterval(updatePrintProgress, 1000);
});
</script>

</body>
</html>