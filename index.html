<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ферма принтеров</title>
<style>
body { margin:0; background:#1e1e1e; font-family: Arial,sans-serif; color:#fff; }
.container { display: flex; flex-wrap: wrap; gap:64px; padding:32px; justify-content: center; }
.card {
  background:#2a2a2a;
  border-radius: 7px;
  width:45%;
  min-width:140px;
  padding:12px;
  cursor:pointer;
  transition: transform 0.15s;
}
.card:active { transform: scale(0.97); }
.card img { width:100%; border-radius:7px; object-fit:contain; }
.card-title { font-size:20px; font-weight:bold; margin-top:8px; }
.status-row { display:flex; justify-content: space-between; margin-top:8px; font-size:16px; }
.progress { margin-top:8px; height:18px; background:#444; border-radius:9px; overflow:hidden; }
.progress-bar { height:100%; width:0%; background:#4caf50; transition: width 0.3s; }
</style>
</head>
<body>

<div class="container">
  <div class="card" onclick="openPrinter(1)">
    <img src="foto/1.png" alt="Bambu Lab A1">
    <div class="card-title">Принтер 1</div>
    <div class="status-row">
      <div>Статус:</div>
      <div id="main-status-1">Простаивает</div>
    </div>
    <div class="status-row">
      <div>Готово:</div>
      <div id="main-progress-1">0%</div>
    </div>
    <div class="status-row">
      <div>Осталось:</div>
      <div id="main-time-1">0с</div>
    </div>
    <div class="progress">
      <div id="main-bar-1" class="progress-bar"></div>
    </div>
  </div>
</div>

<script>
// ===== ПОЛУЧЕНИЕ ДАННЫХ ПРИНТЕРА =====
function getPrinterData() {
  return {
    status: localStorage.getItem("printerStatus") || "idle",
    printName: localStorage.getItem("printerPrintName") || "",
    totalSeconds: parseInt(localStorage.getItem("printerTotalSeconds")) || 0,
    startTime: parseInt(localStorage.getItem("printerStartTime")) || 0,
    endTime: parseInt(localStorage.getItem("printerEndTime")) || 0,
    savedPercent: parseInt(localStorage.getItem("printerSavedPercent")) || 0
  };
}

// ===== СОХРАНЕНИЕ ДАННЫХ =====
function savePrinterData(printer){
  localStorage.setItem("printerStatus", printer.status);
  localStorage.setItem("printerPrintName", printer.printName);
  localStorage.setItem("printerTotalSeconds", printer.totalSeconds);
  localStorage.setItem("printerStartTime", printer.startTime);
  localStorage.setItem("printerEndTime", printer.endTime);
  localStorage.setItem("printerSavedPercent", printer.savedPercent);
}

// ===== ОБНОВЛЕНИЕ UI =====
function updateCard() {
  let printer = getPrinterData();
  const now = Date.now();
  let elapsed = 0;

  if(printer.status==="printing"){
    elapsed = Math.floor((now - printer.startTime)/1000);
    if(elapsed >= printer.totalSeconds){
      printer.status="idle";
      elapsed = printer.totalSeconds;
      printer.savedPercent = 100;
      savePrinterData(printer);
    }
  } else if(printer.status==="stopped"){
    elapsed = Math.floor(printer.totalSeconds * printer.savedPercent / 100);
  } else {
    elapsed = 0;
    printer.savedPercent = 0;
  }

  let percent = printer.totalSeconds ? Math.floor((elapsed/printer.totalSeconds)*100) : 0;
  if(printer.status==="stopped") percent = printer.savedPercent;
  else printer.savedPercent = percent;

  // обновляем UI
  document.getElementById("main-status-1").textContent = printer.status==="idle" ? "Простаивает" : printer.status==="printing" ? "Печать" : "Печать остановлена";
  document.getElementById("main-progress-1").textContent = percent + "%";
  let remaining = printer.totalSeconds - elapsed;
  document.getElementById("main-time-1").textContent = printer.status==="printing" ? remaining + "с" : "0с";

  // цвет полоски и текста
  const bar = document.getElementById("main-bar-1");
  const statusText = document.getElementById("main-status-1");
  if(printer.status==="stopped"){
    bar.style.background="orange";
    statusText.style.color="orange";
  } else {
    bar.style.background="#4caf50";
    statusText.style.color="#fff";
  }

  bar.style.width = percent+"%";

  savePrinterData(printer);
}

// ===== ОБНОВЛЕНИЕ КАЖДУЮ СЕКУНДУ =====
setInterval(updateCard, 1000);

function openPrinter(id){
  window.location.href="printer.html";
}

// инициализация
updateCard();
</script>
</body>
</html>

