<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ферма принтеров</title>

<style>
body{
  margin:0;
  background:#1e1e1e;
  font-family:Arial,sans-serif;
  color:#fff;
}

.container{
  display:flex;
  flex-wrap:wrap;
  gap:64px;
  padding:32px;
  justify-content:center;
}

.card{
  position:relative;
  background:#2a2a2a;
  border-radius:7px;
  width:45%;
  min-width:140px;
  padding:12px;
  cursor:pointer;
}

.card img{
  width:100%;
  border-radius:7px;
  object-fit:contain;
}

.card-title{
  font-size:20px;
  font-weight:bold;
  margin-top:8px;
  display:flex;
  align-items:center;
  gap:8px;
}

.color-indicator{
  width:16px;
  height:16px;
  border-radius:50%;
}

.status-row{
  display:flex;
  justify-content:space-between;
  margin-top:8px;
  font-size:16px;
}

.progress{
  margin-top:8px;
  height:18px;
  background:#444;
  border-radius:9px;
  overflow:hidden;
}

.progress-bar{
  height:100%;
  width:0%;
}

.red-badge{
  position:absolute;
  top:8px;
  right:8px;
  width:18px;
  height:18px;
  border-radius:50%;
  background:red;
  color:#fff;
  font-size:12px;
  font-weight:bold;
  display:none;
  align-items:center;
  justify-content:center;
}

.add-card{
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  border:2px dashed #555;
  color:#aaa;
  font-size:20px;
}

.add-card:hover{
  border-color:#0fb6ec;
  color:#0fb6ec;
}

@keyframes pulse{
  0%{background:#4caf50;}
  50%{background:#00ff00;}
  100%{background:#4caf50;}
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#2a2a2a;
  padding:20px;
  border-radius:8px;
  width:300px;
}

.modal-content input{
  width:100%;
  margin-bottom:10px;
  padding:8px;
  background:#1e1e1e;
  border:none;
  color:#fff;
}

.modal-content button{
  width:100%;
  padding:10px;
  background:#4caf50;
  border:none;
  color:#fff;
  font-size:16px;
}
</style>
</head>

<body>

<div class="container" id="container"></div>

<!-- МОДАЛКА -->
<div class="modal" id="modal">
  <div class="modal-content">
    <input id="pName" placeholder="Название принтера">
    <input id="pModel" placeholder="Модель принта">
    <input id="pPhoto" type="file" accept="image/*">
    <button onclick="addPrinter()">Добавить принтер</button>
  </div>
</div>

<script>
/* ===== ХРАНЕНИЕ ===== */
function getPrinters(){
  return JSON.parse(localStorage.getItem("printers")||"[]");
}

function savePrinters(p){
  localStorage.setItem("printers",JSON.stringify(p));
}

/* ===== РЕНДЕР ===== */
function render(){
  const wrap=document.getElementById("container");
  wrap.innerHTML="";
  const printers=getPrinters();

  printers.forEach((p,i)=>{
    const card=document.createElement("div");
    card.className="card";
    card.onclick=()=>location.href=`printer.html?id=${i}`;

    let percent=p.savedPercent||0;

    if(p.status==="printing" && p.totalSeconds){
      const elapsed=Math.floor((Date.now()-p.startTime)/1000);
      percent=Math.min(100,Math.floor(elapsed/p.totalSeconds*100));
      p.savedPercent=percent;
      if(percent>=100) p.status="finished";
    }

    let barColor="#444";
    let anim="none";
    let statusColor="#fff";

    if(p.status==="printing") barColor="#4caf50";
    if(p.status==="stopped"){barColor="orange";statusColor="orange";}
    if(p.status==="finished"){barColor="#4caf50";anim="pulse 1s infinite";statusColor="#4caf50";}
    if(p.status==="repair"){barColor="red";statusColor="red";percent=100;}

    card.innerHTML=`
      <img src="${p.photo}">
      <div class="card-title">
        ${p.name}
        <div class="color-indicator" style="background:${p.color}"></div>
      </div>

      <div class="status-row">
        <div>Статус:</div>
        <div style="color:${statusColor}">
          ${statusText(p.status)}
        </div>
      </div>

      <div class="status-row">
        <div>Модель:</div>
        <div>${p.model||"—"}</div>
      </div>

      <div class="progress">
        <div class="progress-bar"
          style="width:${percent}%;background:${barColor};animation:${anim}">
        </div>
      </div>
    `;

    wrap.appendChild(card);
  });

  const add=document.createElement("div");
  add.className="card add-card";
  add.innerHTML="➕<br>Добавить принтер";
  add.onclick=()=>modal.style.display="flex";
  wrap.appendChild(add);

  savePrinters(printers);
}

/* ===== ДОБАВЛЕНИЕ ===== */
function addPrinter(){
  if(!pName.value.trim()) return;

  const reader=new FileReader();
  reader.onload=()=>{
    const printers=getPrinters();
    printers.push({
      name:pName.value,
      model:pModel.value,
      photo:reader.result,
      status:"idle",
      savedPercent:0,
      color:"red"
    });
    savePrinters(printers);
    modal.style.display="none";
    pName.value="";
    pModel.value="";
    pPhoto.value="";
    render();
  };
  reader.readAsDataURL(pPhoto.files[0]);
}

/* ===== УТИЛ ===== */
function statusText(s){
  return s==="idle"?"Простаивает":
         s==="printing"?"Печать":
         s==="stopped"?"Остановлена":
         s==="finished"?"Готово":
         "На ремонте";
}

render();
setInterval(render,500);
</script>

</body>
</html>

