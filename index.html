<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ферма принтеров</title>
<style>
body { margin:0; background:#1e1e1e; font-family: Arial,sans-serif; color:#fff; }
.container { display: flex; flex-wrap: wrap; gap:64px; padding:32px; justify-content: center; }

.card {
  position: relative;
  background:#2a2a2a;
  border-radius: 7px;
  width:45%;
  min-width:140px;
  padding:12px;
  cursor:pointer;
  transition: transform 0.15s;
}
.card:active { transform: scale(0.97); }

.card img { width:100%; border-radius:7px; object-fit:contain; }
.card-title { font-size:20px; font-weight:bold; margin-top:8px; display:flex; align-items:center; gap:8px; }
.color-indicator { width:16px; height:16px; border-radius:50%; }

.status-row { display:flex; justify-content: space-between; margin-top:8px; font-size:16px; }
.progress { margin-top:8px; height:18px; background:#444; border-radius:9px; overflow:hidden; }
.progress-bar { height:100%; width:0%; background:#4caf50; transition: width 0.3s; }

@keyframes greenPulse {
  0% { background-color: #4caf50; }
  50% { background-color: #7CFC00; }
  100% { background-color: #4caf50; }
}
.progress-bar.completed { animation: greenPulse 1s infinite; }

.notification {
  position: absolute;
  top:8px;
  right:8px;
  width:20px;
  height:20px;
  border-radius:50%;
  background:red;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:14px;
  font-weight:bold;
  color:#fff;
  display:none;
}
</style>
</head>
<body>

<div class="container" id="printer-container">
  <div class="card" data-id="1" onclick="openPrinter(1)">
    <img src="foto/1.png" alt="Bambu Lab A1">
    <div class="card-title">
      Принтер 1
      <div class="color-indicator" id="main-color-1"></div>
    </div>
    <div class="status-row">
      <div>Статус:</div>
      <div id="main-status-1">Простаивает</div>
    </div>
    <div class="status-row">
      <div>Модель:</div>
      <div id="main-print-1">—</div>
    </div>
    <div class="progress">
      <div id="main-bar-1" class="progress-bar"></div>
    </div>
    <div class="notification" id="notif-1">1</div>
  </div>
</div>

<script>
// ===== Получение данных принтера =====
function getPrinterData(id){
  return {
    status: localStorage.getItem(`printerStatus_${id}`) || "idle",
    printName: localStorage.getItem(`printerPrintName_${id}`) || "",
    totalSeconds: parseInt(localStorage.getItem(`printerTotalSeconds_${id}`)) || 0,
    startTime: parseInt(localStorage.getItem(`printerStartTime_${id}`)) || 0,
    savedPercent: parseInt(localStorage.getItem(`printerSavedPercent_${id}`)) || 0,
    color: localStorage.getItem(`printerColor_${id}`) || "red",
    completedNotified: localStorage.getItem(`printerCompletedNotified_${id}`) === "true"
  };
}

function savePrinterData(id, data){
  localStorage.setItem(`printerStatus_${id}`, data.status);
  localStorage.setItem(`printerPrintName_${id}`, data.printName);
  localStorage.setItem(`printerTotalSeconds_${id}`, data.totalSeconds);
  localStorage.setItem(`printerStartTime_${id}`, data.startTime);
  localStorage.setItem(`printerSavedPercent_${id}`, data.savedPercent);
  localStorage.setItem(`printerColor_${id}`, data.color);
  localStorage.setItem(`printerCompletedNotified_${id}`, data.completedNotified);
}

// ===== Обновление UI =====
function updateCard(id){
  let printer = getPrinterData(id);
  const now = Date.now();
  let elapsed = 0;

  if(printer.status==="printing"){
    elapsed = Math.floor((now - printer.startTime)/1000);
    if(elapsed >= printer.totalSeconds){
      printer.status="completed";
      elapsed = printer.totalSeconds;
      printer.savedPercent = 100;
      printer.completedNotified = false;
    }
  } else if(printer.status==="stopped"){
    elapsed = Math.floor(printer.totalSeconds * printer.savedPercent / 100);
  } else if(printer.status==="completed"){
    elapsed = printer.totalSeconds;
  }

  let percent = printer.totalSeconds ? Math.floor((elapsed/printer.totalSeconds)*100) : 0;
  if(printer.status==="stopped") percent = printer.savedPercent;
  else printer.savedPercent = percent;

  document.getElementById(`main-status-${id}`).textContent = 
    printer.status==="idle" ? "Простаивает" :
    printer.status==="printing" ? "Печать" :
    printer.status==="stopped" ? "Печать остановлена" :
    "Готово";

  document.getElementById(`main-print-${id}`).textContent = printer.printName || "—";

  const bar = document.getElementById(`main-bar-${id}`);
  bar.style.width = percent + "%";

  if(printer.status==="stopped"){
    bar.style.background="orange";
    bar.classList.remove("completed");
    document.getElementById(`main-status-${id}`).style.color="orange";
  } else if(printer.status==="completed"){
    bar.classList.add("completed");
    document.getElementById(`main-status-${id}`).style.color="#7CFC00";
  } else {
    bar.style.background="#4caf50";
    bar.classList.remove("completed");
    document.getElementById(`main-status-${id}`).style.color="#fff";
  }

  document.getElementById(`main-color-${id}`).style.background = printer.color;

  // уведомление
  const notif = document.getElementById(`notif-${id}`);
  notif.style.display = (printer.status==="completed" && !printer.completedNotified) ? "flex" : "none";

  savePrinterData(id, printer);
}

function updateAllCards(){
  const cards = document.querySelectorAll(".card");
  cards.forEach(c=>{
    const id = c.dataset.id;
    updateCard(id);
  });
}

setInterval(updateAllCards,1000);
updateAllCards();

function openPrinter(id){
  window.location.href = `printer.html?id=${id}`;
}
</script>
</body>
</html>
