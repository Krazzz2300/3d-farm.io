<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ферма принтеров</title>
<style>
body { margin:0; background:#1e1e1e; font-family: Arial,sans-serif; color:#fff; }
.container { display: flex; flex-wrap: wrap; gap:64px; padding:32px; justify-content: center; }

.card {
  position: relative;
  background:#2a2a2a;
  border-radius: 7px;
  width:45%;
  min-width:140px;
  padding:12px;
  cursor:pointer;
  transition: transform 0.15s;
}
.card:active { transform: scale(0.97); }

.card img { width:100%; border-radius:7px; object-fit:contain; }

.card-title { font-size:20px; font-weight:bold; margin-top:8px; display:flex; align-items:center; gap:8px; }

.color-indicator { width:16px; height:16px; border-radius:50%; background:red; }

.status-row { display:flex; justify-content: space-between; margin-top:8px; font-size:16px; }

.progress { margin-top:8px; height:18px; background:#444; border-radius:9px; overflow:hidden; }

.progress-bar { height:100%; width:0%; background:#4caf50; transition: width 0.3s; }

.red-badge {
  position: absolute;
  top:8px;
  right:8px;
  width:18px;
  height:18px;
  border-radius:50%;
  background:red;
  color:#fff;
  font-size:12px;
  font-weight:bold;
  display:none;
  align-items:center;
  justify-content:center;
}

@keyframes pulse {
  0% { background-color: #4caf50; }
  50% { background-color: #00ff00; }
  100% { background-color: #4caf50; }
}
</style>
</head>
<body>

<div class="container">
  <div class="card" onclick="openPrinter(1)">
    <img src="foto/1.png" alt="Bambu Lab A1">
    <div class="card-title">
      Принтер 1
      <div class="color-indicator" id="main-color-1"></div>
    </div>
    <div class="status-row">
      <div>Статус:</div>
      <div id="main-status-1">Простаивает</div>
    </div>
    <div class="status-row">
      <div>Модель:</div>
      <div id="main-model-1">—</div>
    </div>
    <div class="progress">
      <div id="main-bar-1" class="progress-bar"></div>
    </div>
    <div class="red-badge" id="main-notify-1">1</div>
  </div>
</div>

<script>
// ===== ПОЛУЧЕНИЕ ДАННЫХ ПРИНТЕРА =====
function getPrinterData() {
  return {
    status: localStorage.getItem("printerStatus") || "idle",
    printName: localStorage.getItem("printerPrintName") || "",
    totalSeconds: parseInt(localStorage.getItem("printerTotalSeconds")) || 0,
    startTime: parseInt(localStorage.getItem("printerStartTime")) || 0,
    savedPercent: parseInt(localStorage.getItem("printerSavedPercent")) || 0,
    color: localStorage.getItem("printerColor") || "red",
    finishedNotified: localStorage.getItem("printerFinishedNotified") === "true"
  };
}

function savePrinterData(printer){
  localStorage.setItem("printerStatus", printer.status);
  localStorage.setItem("printerPrintName", printer.printName);
  localStorage.setItem("printerTotalSeconds", printer.totalSeconds);
  localStorage.setItem("printerStartTime", printer.startTime);
  localStorage.setItem("printerSavedPercent", printer.savedPercent);
  localStorage.setItem("printerColor", printer.color);
  localStorage.setItem("printerFinishedNotified", printer.finishedNotified);
}

// ===== ОБНОВЛЕНИЕ UI =====
function updateCard() {
  let printer = getPrinterData();
  const now = Date.now();
  let elapsed = 0;

  if(printer.status==="printing"){
    elapsed = Math.floor((now - printer.startTime)/1000);
    if(elapsed >= printer.totalSeconds){
      printer.status="finished";
      printer.savedPercent = 100;
      printer.finishedNotified = false;
      savePrinterData(printer);
    }
  } else if(printer.status==="stopped"){
    elapsed = Math.floor(printer.totalSeconds * printer.savedPercent / 100);
  }

  let percent = printer.totalSeconds ? Math.floor((elapsed/printer.totalSeconds)*100) : 0;
  if(printer.status==="stopped") percent = printer.savedPercent;
  else printer.savedPercent = percent;

  // Статус и модель
  const statusText = document.getElementById("main-status-1");
  const modelText = document.getElementById("main-model-1");
  const bar = document.getElementById("main-bar-1");
  const notify = document.getElementById("main-notify-1");

  statusText.textContent =
    printer.status==="idle" ? "Простаивает" :
    printer.status==="printing" ? "Печать" :
    printer.status==="stopped" ? "Печать остановлена" :
    "Готово";

  modelText.textContent =
    printer.status==="idle" ? "—" : printer.printName || "—";

  // Полоска прогресса
  if(printer.status==="idle"){
    bar.style.animation="none";
    bar.style.background="#444"; // серый при простое
    statusText.style.color="#fff";
    notify.style.display="none";
  } else if(printer.status==="stopped"){
    bar.style.animation="none";
    bar.style.background="orange";
    statusText.style.color="orange";
    notify.style.display="none";
  } else if(printer.status==="finished"){
    bar.style.animation="pulse 1s infinite";
    bar.style.background="#4caf50"; // зелёная
    statusText.style.color="#4caf50";
    notify.style.display="flex";
  } else if(printer.status==="printing"){
    bar.style.animation="none";
    bar.style.background="#4caf50";
    statusText.style.color="#fff";
    notify.style.display="none";
  }

  bar.style.width = percent + "%";
  document.getElementById("main-color-1").style.background = printer.color;

  savePrinterData(printer);
}

setInterval(updateCard, 1000);
updateCard();

function openPrinter(id){
  window.location.href="printer.html";
}
</script>
</body>
</html>
