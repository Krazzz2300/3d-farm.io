<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Farm - –í—Ö–æ–¥</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a1a1a;
            color: white;
            font-family: Arial;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .logo {
            font-size: 48px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        
        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
        }
        
        /* –§–æ—Ä–º—ã */
        .form {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 16px;
            border: 1px solid #444;
            margin-bottom: 20px;
        }
        
        .input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .switch {
            color: #888;
            margin-top: 15px;
            cursor: pointer;
        }
        
        .switch:hover {
            color: #4CAF50;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        
        .checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            font-size: 14px;
            color: #aaa;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üñ®Ô∏è</div>
        <div class="title">3D Farm Manager</div>
        
        <!-- –û—à–∏–±–∫–∞ -->
        <div class="error" id="error"></div>
        
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div class="form" id="login-form">
            <input type="email" id="login-email" class="input" placeholder="–í–∞—à email">
            <input type="password" id="login-password" class="input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="login()">–í–û–ô–¢–ò</button>
            <div class="switch" onclick="showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å</div>
        </div>
        
        <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="form" id="register-form" style="display: none;">
            <input type="email" id="register-email" class="input" placeholder="–í–∞—à email">
            <input type="password" id="register-password" class="input" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
            <input type="password" id="register-password2" class="input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            
            <div class="checkbox">
                <input type="checkbox" id="agree-checkbox">
                <label>–Ø –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</label>
            </div>
            
            <button class="btn" onclick="register()">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
            <div class="switch" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
        </div>
    </div>

    <script>
        // ===== FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyDdA4kSxL-CYt3egpUeLLp0XMOB9GyN604",
            authDomain: "ferm-3d.firebaseapp.com",
            projectId: "ferm-3d",
            storageBucket: "ferm-3d.firebasestorage.app",
            messagingSenderId: "497797661146",
            appId: "1:497797661146:web:58125a76c6b44fd91d40e3"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ===== –§–£–ù–ö–¶–ò–ò =====
        function showError(text) {
            document.getElementById('error').innerText = text;
            document.getElementById('error').style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function showRegister() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            hideError();
        }
        
        function showLogin() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            hideError();
        }
        
        // ===== –í–•–û–î =====
        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!email || !password) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const user = await auth.signInWithEmailAndPassword(email, password);
                window.location.href = 'main.html';
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    showError('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                } else if (error.code === 'auth/wrong-password') {
                    showError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                } else {
                    showError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                }
            }
        }
        
        // ===== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =====
        async function register() {
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const password2 = document.getElementById('register-password2').value.trim();
            const agreed = document.getElementById('agree-checkbox').checked;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∏
            if (!email || !password || !password2) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (password !== password2) {
                showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            if (password.length < 6) {
                showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            if (!agreed) {
                showError('–ü—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            try {
                // 1. –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;
                
                // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await db.collection('users').doc(userId).set({
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    subscription: 'free'
                });
                
                // 3. –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—É—é —Ñ–µ—Ä–º—É
                await createFirstFarm(userId, email);
                
                // 4. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                window.location.href = 'main.html';
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showError('Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è');
                } else {
                    showError('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        // ===== –°–û–ó–î–ê–ù–ò–ï –§–ï–†–ú–´ =====
        async function createFirstFarm(userId, email) {
            try {
                const farmId = 'farm_' + Date.now();
                
                // –°–æ–∑–¥–∞—ë–º —Ñ–µ—Ä–º—É
                await db.collection('users').doc(userId).collection('farms').doc(farmId).set({
                    id: farmId,
                    name: '–ú–æ—è —Ñ–µ—Ä–º–∞',
                    ownerId: userId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    subscription: 'free'
                });
                
                // –°–æ–∑–¥–∞—ë–º –¥–µ–º–æ-–ø—Ä–∏–Ω—Ç–µ—Ä
                await db.collection('users').doc(userId).collection('farms').doc(farmId)
                    .collection('printers').doc('printer1').set({
                        id: 'printer1',
                        name: '–ú–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä',
                        model: 'Creality Ender 3',
                        status: 'idle',
                        color: 'red',
                        progress: 0,
                        printName: '',
                        image: 'foto/creality_ender3.jpg',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–µ—Ä–º—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await db.collection('users').doc(userId).update({
                    currentFarmId: farmId
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–µ—Ä–º—ã:', error);
            }
        }
        
        // ===== –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò =====
        auth.onAuthStateChanged(user => {
            if (user) {
                // –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Å—Ä–∞–∑—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                window.location.href = 'main.html';
            }
        });
    </script>
</body>
</html>